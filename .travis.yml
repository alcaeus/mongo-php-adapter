language: php
dist: xenial

services:
  - mongodb

php:
  - 7.0
  - 7.1
  - 7.2
  - 7.3
  - 7.4

addons:
  apt:
    sources:
      - sourceline: "deb [arch=amd64] https://repo.mongodb.org/apt/ubuntu trusty/mongodb-org/3.4 multiverse"
        key_url: "https://www.mongodb.org/static/pgp/server-3.4.asc"
      - "mongodb-upstart"
    packages: ['mongodb-org-server']

install:
  - .travis/install-extension.sh
  - composer update ${COMPOSER_FLAGS}

script:
  - vendor/bin/simple-phpunit

jobs:
  include:
    # Test against legacy driver to ensure validity of the test suite
    - stage: Test
      dist: trusty
      php: 5.6
      env: DRIVER_VERSION="1.7.5" SYMFONY_DEPRECATIONS_HELPER=9999999
      before_install:
        - yes '' | pecl -q install -f mongo

cache:
  directories:
    - $HOME/.composer/cache
